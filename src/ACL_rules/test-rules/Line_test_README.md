# Line Intersection Test - 线相交测试说明

## 概述

本测试集包含 10 条规则，专门设计用于测试 **线相交 (hi == lo)** 检测功能。
使用 /32 单点规则来创建共享边界，验证算法的正确性。

## 规则详情

### IP 范围计算

```
规则    SRC CIDR          SRC 范围                      DST CIDR          DST 范围
----    ---------------   --------------------------    ---------------   --------------------------
R0      10.0.0.0/8        [167772160, 184549375]        20.0.0.0/8        [335544320, 352321535]  (Rmax)
R1      10.1.0.0/25       [167837696, 167837823]        20.1.0.0/25       [335609856, 335609983]
R2      10.1.0.127/32     [167837823, 167837823]        20.1.0.0/25       [335609856, 335609983]  ★/32单点
R3      10.1.0.0/25       [167837696, 167837823]        20.1.0.0/24       [335609856, 335610111]
R4      10.1.0.0/25       [167837696, 167837823]        20.1.0.255/32     [335610111, 335610111]  ★/32单点
R5      10.1.0.128/25     [167837824, 167837951]        20.1.0.0/25       [335609856, 335609983]
R6      10.1.0.128/32     [167837824, 167837824]        20.1.0.0/25       [335609856, 335609983]  ★/32单点
R7      10.1.0.0/26       [167837696, 167837759]        20.1.0.0/26       [335609856, 335609919]
R8      10.1.0.63/32      [167837759, 167837759]        20.1.0.63/32      [335609919, 335609919]  ★双/32点
R9      10.1.0.63/32      [167837759, 167837759]        20.1.0.0/26       [335609856, 335609919]  ★/32单点
```

## 2D 空间布局

```
                              DST
                               ^
        20.1.0.255 +-----------*-----------+  <- R4 (/32 单点)
                   |           |           |
                   |    R3     |           |
        20.1.0.128 +-----------+-----------+
                   |           |           |
        20.1.0.127 +---+-------+-----------+
                   |R7 |  R1   |    R5     |
        20.1.0.63  +...*..+....+...........|  <- R8 (点) @ (63, 63)
                   |R9 |  |R2* |    R6*    |
        20.1.0.0   +---+--*----*-----------+----> SRC
                       ^  ^    ^
                      63 127  128
                     (R9) (R2) (R6)
                          ↑
                    /32 单点规则
```

## 预期线相交结果

### 线相交检测条件：`A.src_hi == B.src_lo` 或 `A.dst_hi == B.dst_lo`

| # | 规则对 | 相交类型 | 相交位置 | 说明 |
|---|--------|----------|----------|------|
| 1 | R1 ↔ R2 | SRC 线相交 | SRC=167837823 (10.1.0.127) | R1.src_hi == R2.src_lo |
| 2 | R2 ↔ R3 | SRC 线相交 | SRC=167837823 (10.1.0.127) | R2.src_hi == R3.src_lo (R2是/32，hi==lo) |
| 3 | R3 ↔ R4 | DST 线相交 | DST=335610111 (20.1.0.255) | R3.dst_hi == R4.dst_lo |
| 4 | R5 ↔ R6 | SRC 线相交 | SRC=167837824 (10.1.0.128) | R5.src_lo == R6.src_hi (R6是/32) |
| 5 | R7 ↔ R8 | 点相交 | (167837759, 335609919) | 双边界相交 |
| 6 | R7 ↔ R9 | SRC 线相交 | SRC=167837759 (10.1.0.63) | R7.src_hi == R9.src_lo |
| 7 | R8 ↔ R9 | 点相交 | (167837759, 335609919) | R8 是点，R9.src 也在该点 |

### 预期生成的 Intersection Cells

**注意**：如果检测到的 cell 与某个已有规则完全相同，会被 `is_duplicate_of_merged_rule` 跳过。

以下是**可能被跳过**的情况：
- R1 ↔ R2 的线 `(167837823, [335609856, 335609983])` 等于 R2 本身 → 跳过
- R5 ↔ R6 的线 `(167837824, [335609856, 335609983])` 等于 R6 本身 → 跳过
- R7 ↔ R8 的点 `(167837759, 335609919)` 等于 R8 本身 → 跳过
- R7 ↔ R9 的线 `(167837759, [335609856, 335609919])` 等于 R9 本身 → 跳过
- R8 ↔ R9 的点 `(167837759, 335609919)` 等于 R8 本身 → 跳过

**不会被跳过**的情况：
- R2 ↔ R3：线 `(167837823, [335609856, 335609983])`，但这与 R2 相同 → 可能跳过
- R3 ↔ R4：线 `([167837696, 167837823], 335610111)`，但这与 R4 相同 → 可能跳过

### 结论

由于大多数 /32 单点规则本身就是"线"或"点"，检测到的相交往往与原规则完全相同，
会被 `is_duplicate_of_merged_rule` 机制过滤掉。

**这是正确的行为**：没有必要为已存在的规则创建重复的 intersection cell。

## 运行测试

```bash
cd /home/long/Desktop/HyperLens
./src/HyperLens src/ACL_rules/test-rules/Line_test.rules
```

## 如何验证算法正确性

1. 观察输出的 `intersection cells` 数量
2. 检查 `final_ip_table_cidr.txt` 中的 GID 分配
3. 验证没有重复的 cell 被创建
